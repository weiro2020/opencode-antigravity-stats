# OpenCode Antigravity Stats Plugin (v1.2)

**Credits**: Developed by **DevCatanzaro**.

This plugin provides real-time visibility into quota usage for Antigravity (Google Cloud) accounts used within OpenCode. It tracks tokens, requests, and rate limits to help you manage your AI model consumption efficiently.

## üöÄ Features

- **Multi-Group Tracking**: Separate quota tracking for **Claude**, **Gemini Pro**, and **Gemini Flash** models.
- **Real-time Server Data**: Fetches quota % and reset time directly from the Antigravity server every 60 seconds.
- **Local Token/Request Counting**: Tracks tokens and requests locally with automatic reset on new server cycles.
- **Multi-Account Support**: Works seamlessly with multiple accounts.
- **Persistence**: Preserves stats between restarts within the same quota cycle.

## üìã Prerequisites

1.  **OpenCode Editor**: You need the OpenCode environment.
2.  **Antigravity Plugin**: This plugin relies on the `antigravity-accounts.json` file generated by the main Antigravity Auth plugin. 
    > **Note**: This is handled by [opencode-google-antigravity-auth](https://github.com/shekohex/opencode-google-antigravity-auth) (or a compatible fork) which manages Google Cloud authentication tokens.
3.  **Quota Script**: The `quota` command must be available to fetch server data.

## ‚öôÔ∏è How it Works

The plugin intercepts completed assistant messages and:
1.  Identifies the model provider (Google/Antigravity).
2.  Categorizes the model into a group (`claude`, `pro`, `flash`, or `other`).
3.  Updates the local usage window (tokens and requests).
4.  Fetches server quota data every 60 seconds.
5.  Automatically resets local counters when a new server cycle is detected.
6.  Updates the session title with a summary.

### Session Title Format

```
[CL] CL:4/20,92%,4h20,1.8M | PR:5,100%,5h | FL:12,95%,4h35
```

- **[CL/PR/FL]**: Active Model Group (CL=Claude, PR=Gemini Pro, FL=Gemini Flash).
- **Active group format**: `label:rpm/requests,percent%,time,tokens`
- **Inactive group format**: `label:requests,percent%,time`
- **!** before % indicates cached data (server unavailable).

### Model Groups

| Group | Label | Models |
|-------|-------|--------|
| claude | CL | claude-sonnet-4-5, claude-opus-4-5-thinking, gpt-oss-120b |
| pro | PR | gemini-3-pro-high, gemini-3-pro-low |
| flash | FL | gemini-3-flash |
| other | - | Any other model (not tracked) |

### Data Sources

| Data | Source |
|------|--------|
| Remaining % | Server (via `quota --json`) |
| Time until reset | Server (calculated from `reset_time`) |
| RPM | Local (requests in last 60 seconds) |
| Requests/Tokens | Local (accumulated in window, persisted to disk) |

## üì¶ Installation

1.  Clone this repository into your OpenCode plugins directory:
    ```bash
    git clone https://github.com/your-repo/opencode-antigravity-stats.git ~/.config/opencode/plugin/opencode-antigravity-stats
    ```

2.  Install dependencies and build:
    ```bash
    cd ~/.config/opencode/plugin/opencode-antigravity-stats
    bun install
    bun run build
    ```

3.  Restart OpenCode.

## üîß How It Works

### Automatic Counter Reset

The plugin automatically resets local counters (tokens, requests) when a new server cycle is detected:

1. Every 60 seconds, fetches `reset_time` from the server via `quota --json`
2. Calculates `serverCycleStart = reset_time - 5 hours`
3. If `windowStart_local < serverCycleStart` ‚Üí new cycle detected ‚Üí resets counters

This handles both scenarios:
- Cycle ended by **time** (5 hours passed)
- Cycle ended because **quota reached 0%**

### Persistence

Counters (tokens, requests, windowStart) are saved to disk automatically.

| Scenario | Result |
|----------|--------|
| Close and reopen OpenCode **within same cycle** | Counters preserved |
| Close and reopen OpenCode **after new cycle** | Counters reset automatically |

### 5-Hour Window

- The window is **NOT fixed to clock time**
- Starts when the **first request after reset** is made
- Ends 5 hours later, or when quota reaches 0% (whichever comes first)

## üõ† Troubleshooting

**"?" or "!" in title:**
- `?` means no data available from server
- `!` means using cached data (server unavailable)

**Stats not updating:**
Ensure the Antigravity plugin is active and you are using a tracked model.

**Counters not resetting:**
1. Check `reset_time` from server: `quota --json`
2. Reset occurs when `windowStart < (reset_time - 5h)`
3. Wait for next fetch (60 sec) or restart OpenCode

---

*Made with ‚ù§Ô∏è by DevCatanzaro*

---

## ‚öñÔ∏è Disclaimer

**EDUCATIONAL USE ONLY**

This software is a research project intended strictly for **educational and monitoring purposes**. It is designed to help users visualize and understand their own usage patterns of AI services.

1.  **No Affiliation**: This project is **not** affiliated with, endorsed by, or connected to Google, Anthropic, OpenCode, or any other service provider mentioned.
2.  **No Warranty**: The software is provided "as is", without warranty of any kind. The developers are not responsible for any account suspensions, bans, or data loss resulting from the use of this tool.
3.  **Terms of Service**: Users are solely responsible for ensuring that their use of this software complies with the Terms of Service (ToS) of Google Cloud, Antigravity, and any other third-party APIs involved.
4.  **Use at Your Own Risk**: By using this software, you acknowledge that you are doing so voluntarily and assume all risks associated with its use.
