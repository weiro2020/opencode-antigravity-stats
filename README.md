# OpenCode Antigravity Stats Plugin (v1.2)

**Credits**: Developed by **DevCatanzaro**.

This plugin provides real-time visibility into quota usage for Antigravity (Google Cloud) accounts used within OpenCode. It tracks tokens, requests, and rate limits to help you manage your AI model consumption efficiently.

## ğŸš€ Features

- **Multi-Group Tracking**: Separate quota tracking for **Claude**, **Gemini Pro**, and **Gemini Flash** models.
- **Real-time Server Data**: Fetches quota % and reset time directly from the Antigravity server every 60 seconds.
- **Local Token/Request Counting**: Tracks tokens and requests locally with automatic reset on new server cycles.
- **Multi-Account Support**: Works seamlessly with multiple accounts.
- **Persistence**: Preserves stats between restarts within the same quota cycle.

## ğŸ“‹ Prerequisites

1.  **OpenCode Editor**: You need the OpenCode environment.
2.  **Antigravity Plugin**: This plugin relies on the `antigravity-accounts.json` file generated by the main Antigravity Auth plugin. 
    > **Note**: This is handled by [opencode-google-antigravity-auth](https://github.com/shekohex/opencode-google-antigravity-auth) (or a compatible fork) which manages Google Cloud authentication tokens.
3.  **Quota Script**: The `quota` command must be available to fetch server data. See [Auxiliary Scripts](#-auxiliary-scripts) section.

## ğŸ–¥ï¸ Remote Setup (Required)

This plugin requires the **Antigravity Language Server (LS) to run on your Linux server/VPS**, not on your local machine. The LS is what provides quota data via the `quota` script.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         SSH          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Windows/Local PC   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚    Linux VPS        â”‚
â”‚                     â”‚                      â”‚                     â”‚
â”‚  Antigravity App    â”‚                      â”‚  Language Server    â”‚
â”‚  (Remote SSH mode)  â”‚                      â”‚  OpenCode + Plugin  â”‚
â”‚                     â”‚                      â”‚  quota script       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Setup Steps

1. **Connect Antigravity via SSH Remote**
   
   In Antigravity (Windows), use the Remote SSH extension to connect to your VPS. This spawns the Language Server on the VPS.

2. **Login with your Google Account**
   
   Login to Antigravity with the **same Google account** used for OpenCode's Antigravity auth plugin. The LS will use this account's quota.

3. **Verify the LS is running**
   
   On your VPS, run:
   ```bash
   ps aux | grep language_server_linux
   ```
   You should see the LS process running.

4. **Test the quota script**
   
   ```bash
   quota
   ```
   This should display your current quota. If it works, the plugin can fetch data.

### Keeping the Language Server Running

When you close Antigravity on Windows, it normally sends a shutdown signal to the LS on the VPS. To keep the LS running after closing Antigravity:

**Instead of closing with the X button or Alt+F4:**
1. Open **Task Manager** (Ctrl+Shift+Esc)
2. Find the Antigravity process
3. Click **End Task**

This kills the client without sending the shutdown signal, so the LS keeps running on the VPS.

| Close Method | LS on VPS |
|--------------|-----------|
| X button / Alt+F4 | Shuts down |
| Task Manager â†’ End Task | Keeps running |

> **Why?** Keeping the LS running allows the `quota` script to fetch data even when Antigravity is closed. When you reopen Antigravity, it reconnects to the existing LS.

### Preventing Auto-Shutdown

The LS has a 3-hour inactivity timeout. Use the `antigravity-server-wrapper.sh` script (see [Auxiliary Scripts](#-auxiliary-scripts)) to disable this.

## âš™ï¸ How it Works

The plugin intercepts completed assistant messages and:
1.  Identifies the model provider (Google/Antigravity).
2.  Categorizes the model into a group (`claude`, `pro`, `flash`, or `other`).
3.  Updates the local usage window (tokens and requests).
4.  Fetches server quota data every 60 seconds.
5.  Automatically resets local counters when a new server cycle is detected.
6.  Updates the session title with a summary.

### Session Title Format

```
[CL] CL:4/20,92%,4h20,1.8M | PR:5,100%,5h | FL:12,95%,4h35
```

- **[CL/PR/FL]**: Active Model Group (CL=Claude, PR=Gemini Pro, FL=Gemini Flash).
- **Active group format**: `label:rpm/requests,percent%,time,tokens`
- **Inactive group format**: `label:requests,percent%,time`
- **!** before % indicates cached data (server unavailable).

### Model Groups

| Group | Label | Models |
|-------|-------|--------|
| claude | CL | claude-sonnet-4-5, claude-opus-4-5-thinking, gpt-oss-120b |
| pro | PR | gemini-3-pro-high, gemini-3-pro-low |
| flash | FL | gemini-3-flash |
| other | - | Any other model (not tracked) |

### Data Sources

| Data | Source |
|------|--------|
| Remaining % | Server (via `quota --json`) |
| Time until reset | Server (calculated from `reset_time`) |
| RPM | Local (requests in last 60 seconds) |
| Requests/Tokens | Local (accumulated in window, persisted to disk) |

## ğŸ“¦ Installation

1.  Clone this repository into your OpenCode plugins directory:
    ```bash
    git clone https://github.com/your-repo/opencode-antigravity-stats.git ~/.config/opencode/plugin/opencode-antigravity-stats
    ```

2.  Install dependencies and build:
    ```bash
    cd ~/.config/opencode/plugin/opencode-antigravity-stats
    bun install
    bun run build
    ```

3.  Restart OpenCode.

## ğŸ”§ How It Works

### Automatic Counter Reset

The plugin automatically resets local counters (tokens, requests) when a new server cycle is detected:

1. Every 60 seconds, fetches `reset_time` from the server via `quota --json`
2. Calculates `serverCycleStart = reset_time - 5 hours`
3. If `windowStart_local < serverCycleStart` â†’ new cycle detected â†’ resets counters

This handles both scenarios:
- Cycle ended by **time** (5 hours passed)
- Cycle ended because **quota reached 0%**

### Persistence

Counters (tokens, requests, windowStart) are saved to disk automatically.

| Scenario | Result |
|----------|--------|
| Close and reopen OpenCode **within same cycle** | Counters preserved |
| Close and reopen OpenCode **after new cycle** | Counters reset automatically |

### 5-Hour Window

- The window is **NOT fixed to clock time**
- Starts when the **first request after reset** is made
- Ends 5 hours later, or when quota reaches 0% (whichever comes first)

## ğŸ”Œ Auxiliary Scripts

The `scripts/` directory contains standalone utilities:

### quota

A simple bash wrapper that calls the quota fetcher script. Install:

```bash
cp scripts/quota ~/.local/bin/
chmod +x ~/.local/bin/quota
# Ensure ~/.local/bin is in your PATH
```

### get_antigravity_quota.py

Python script that fetches quota data directly from the Antigravity Language Server via Connect RPC. Features:

- Auto-detects running LS (finds PID, CSRF token, HTTP port)
- Caches data for offline use
- Outputs pretty-printed or JSON

```bash
# Pretty print
python3 scripts/get_antigravity_quota.py

# JSON output (used by plugin)
python3 scripts/get_antigravity_quota.py --json

# Save to cache
python3 scripts/get_antigravity_quota.py --save
```

### antigravity-server-wrapper.sh

Wrapper script that prevents the Antigravity server from auto-shutting down after 3 hours. Filters out the `--enable-remote-auto-shutdown` flag.

**Installation:**

1. Find your antigravity-server binary:
   ```bash
   ls ~/.antigravity-server/bin/*/bin/antigravity-server
   ```

2. Backup the original:
   ```bash
   cp ~/.antigravity-server/bin/<version>/bin/antigravity-server \
      ~/.antigravity-server/bin/<version>/bin/antigravity-server.original
   ```

3. Replace with this wrapper:
   ```bash
   cp scripts/antigravity-server-wrapper.sh ~/.antigravity-server/bin/<version>/bin/antigravity-server
   chmod +x ~/.antigravity-server/bin/<version>/bin/antigravity-server
   ```

> **Note**: Antigravity updates may overwrite this wrapper. Re-apply after updates.

## ğŸ›  Troubleshooting

**\"?\" or \"!\" in title:**
- `?` means no data available from server
- `!` means using cached data (server unavailable)

**Stats not updating:**
Ensure the Antigravity plugin is active and you are using a tracked model.

**Counters not resetting:**
1. Check `reset_time` from server: `quota --json`
2. Reset occurs when `windowStart < (reset_time - 5h)`
3. Wait for next fetch (60 sec) or restart OpenCode

---

## ğŸ—ï¸ Code Architecture

Quick reference for modifying the plugin without reading all the code.

### File Structure

| File | Purpose |
|------|---------|
| `src/index.ts` | Plugin entry point, event hooks, session title formatting |
| `src/collector.ts` | Main logic: tracking, quota fetching, stats accumulation |
| `src/storage.ts` | Disk persistence (load/save stats and quota cache) |
| `src/watcher.ts` | Watches `antigravity-accounts.json` for rate limit changes |
| `src/types.ts` | TypeScript interfaces and constants |
| `src/format.ts` | Formatting for `/stats` command output |

### Key Functions in `collector.ts`

| Function | Line ~  | Purpose |
|----------|---------|---------|
| `getModelGroup()` | 56 | Maps `providerID/modelID` â†’ `claude\|pro\|flash\|other` |
| `recordMessage()` | 168 | Called on each assistant message, updates tokens/requests |
| `fetchServerQuota()` | 610 | Executes `quota --json`, updates `serverQuotaCache` |
| `getQuotaStatsAllGroups()` | 737 | Returns stats for all 3 groups (used for session title) |
| `getServerQuotaForGroup()` | 680 | Gets server % and time for a specific group |

### Session Title Logic (`index.ts`)

The title is built in `updateSessionTitle()` (~line 42):

```typescript
const parts = allGroups.map((g) => {
  if (g.isActive) {
    // Active: rpm/requests, %, time, tokens
    return `${g.label}:${g.rpm}/${g.requestsCount},${pct},${g.timeUntilReset},${formatTokens(g.tokensUsed)}`;
  } else {
    // Inactive: requests, %, time (NO rpm, NO tokens)
    return `${g.label}:${g.requestsCount},${pct},${g.timeUntilReset}`;
  }
});
```

### Data Flow

```
Message received
      â†“
recordMessage() â†’ updates quotaTracking.windows[group]
      â†“
scheduleSave() â†’ debounced write to disk
      â†“
Every 60s: fetchServerQuota() â†’ updates serverQuotaCache
      â†“
updateSessionTitle() â†’ calls getQuotaStatsAllGroups()
      â†“
Session title updated with combined local + server data
```

### Common Modifications

| Want to... | Modify... |
|------------|-----------|
| Change title format | `updateSessionTitle()` in `index.ts` |
| Add new model group | `getModelGroup()` in `collector.ts` |
| Change what data shows for inactive groups | `getQuotaStatsAllGroups()` in `collector.ts` |
| Modify reset logic | Look for `shouldReset` in `getQuotaStatsAllGroups()` |
| Change fetch interval | `startQuotaFetching()` in `collector.ts` (default 60000ms) |

---

## ğŸ”— SSH Tunnel (Alternative to Local LS)

If the local Language Server has delayed quota data, you can use an SSH tunnel to connect directly to the Windows LS for real-time data.

### Why Use the Tunnel?

| Method | Advantage | Disadvantage |
|--------|-----------|--------------|
| Local LS (VPS) | No Windows needed | Quota data may be delayed |
| SSH Tunnel | Real-time data | Requires active tunnel |

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         SSH Tunnel          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Linux VPS              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Windows PC             â”‚
â”‚                         â”‚     localhost:50001         â”‚                         â”‚
â”‚  OpenCode               â”‚          â†•                  â”‚  Antigravity IDE        â”‚
â”‚  Plugin Stats           â”‚     (reverse tunnel)        â”‚  Language Server        â”‚
â”‚  quota script           â”‚                             â”‚  (local HTTP port)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Automatic Setup (Recommended)

Run `setup_tunnel.ps1` on Windows (PowerShell):

```powershell
.\setup_tunnel.ps1
```

The script automatically:
1. Detects the Language Server process
2. Extracts the CSRF token
3. Detects the HTTP port
4. Updates `tunnel_config.json` on the VPS via SSH
5. Starts the tunnel with keep-alive

### Manual Setup

1. **On Windows**, get the LS port and CSRF token
2. **Create tunnel** from Windows:
   ```powershell
   ssh -o ServerAliveInterval=60 -R 50001:127.0.0.1:<LS_PORT> user@vps -p 22
   ```
3. **Create config** on VPS:
   ```bash
   echo '{"port": 50001, "csrf_token": "<TOKEN>", "windows_ls_port": <PORT>}' > ~/.antigravity-standalone/tunnel_config.json
   ```

### Tunnel Files

| File | Purpose |
|------|---------|
| `scripts/setup_tunnel.ps1` | Windows PowerShell script (copy to your PC) |
| `scripts/get_quota_tunnel.py` | Alternative Python script (tunnel only) |
| `tunnel_config.example.json` | Configuration template |

### Data Source Priority

The `quota` script uses these sources in order:

| Priority | Source | Description |
|----------|--------|-------------|
| 1 | Local LS | If a LS is running on the VPS |
| 2 | SSH Tunnel | If local LS is unavailable and tunnel is active |
| 3 | Cache | If no live source is available |

### Verify Tunnel

```bash
# Check if tunnel is listening
ss -tunlp | grep 50001

# Test quota via tunnel
quota --tunnel
```

---

*Made with â¤ï¸ by DevCatanzaro*

---

## âš–ï¸ Disclaimer

**EDUCATIONAL USE ONLY**

This software is a research project intended strictly for **educational and monitoring purposes**. It is designed to help users visualize and understand their own usage patterns of AI services.

1.  **No Affiliation**: This project is **not** affiliated with, endorsed by, or connected to Google, Anthropic, OpenCode, or any other service provider mentioned.
2.  **No Warranty**: The software is provided "as is", without warranty of any kind. The developers are not responsible for any account suspensions, bans, or data loss resulting from the use of this tool.
3.  **Terms of Service**: Users are solely responsible for ensuring that their use of this software complies with the Terms of Service (ToS) of Google Cloud, Antigravity, and any other third-party APIs involved.
4.  **Use at Your Own Risk**: By using this software, you acknowledge that you are doing so voluntarily and assume all risks associated with its use.
