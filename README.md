# OpenCode Antigravity Stats Plugin (v1.2.3)

**Credits**: Developed by **DevCatanzaro**.

This plugin provides real-time visibility into quota usage for Antigravity (Google Cloud) accounts used within OpenCode. It tracks tokens, requests, and rate limits to help you manage your AI model consumption efficiently.

## Features

- **Multi-Group Tracking**: Separate quota tracking for **Claude**, **Gemini Pro**, and **Gemini Flash** models.
- **Real-time Server Data**: Fetches quota % and reset time directly from the Antigravity server every 60 seconds.
- **Local Token/Request Counting**: Tracks tokens and requests locally with automatic reset on new server cycles.
- **Multi-Account Support**: Works seamlessly with multiple accounts.
- **Persistence**: Preserves stats between restarts within the same quota cycle.
- **Silent Operation**: No error toasts or console spam when server is unavailable.

## Prerequisites

1. **OpenCode Editor**: You need the OpenCode environment.
2. **Antigravity Plugin**: This plugin relies on the `antigravity-accounts.json` file generated by the main Antigravity Auth plugin.
3. **SSH Tunnel** (optional): For remote quota fetching from a Windows machine.

## Session Title Format

When quota data is available, the session title shows:

```
[CL] CL:4/20,92%,4h20,1.8M | PR:5,100%,5h | FL:12,95%,4h35
```

Where:
- **[CL/PR/FL]**: Active model group (CL=Claude, PR=Gemini Pro, FL=Gemini Flash)
- **Active group** (full format): `label:rpm/requests,percent%,time,tokens`
- **Inactive groups** (compact): `label:requests,percent%,time`
- **!** before % indicates cached data (server unavailable)

When quota data is unavailable, the title remains unchanged (OpenCode default).

## Installation

1. Clone this repository into your OpenCode plugins directory:
   ```bash
   cd ~/.config/opencode/plugin/
   git clone https://github.com/weiro2020/opencode-antigravity-stats.git
   ```

2. Install dependencies and build:
   ```bash
   cd opencode-antigravity-stats
   npm install
   npm run build
   ```

3. Restart OpenCode.

## Configuration

### Tunnel Setup (for remote LS)

If your Language Server runs on a different machine (e.g., Windows), you can set up an SSH tunnel:

1. Create `tunnel_config.json` in the plugin's `scripts/` directory:
   ```json
   {
     "port": 50001,
     "csrf_token": "your-csrf-token-here"
   }
   ```

2. Establish the tunnel from Windows:
   ```powershell
   ssh -R 50001:127.0.0.1:<LS_PORT> user@your-vps -p <SSH_PORT>
   ```

See `tunnel_config.example.json` for reference.

## Model Groups

| Group | Label | Models |
|-------|-------|--------|
| **Claude** | CL | Claude Sonnet 4.5, Claude Opus 4.5 (Thinking), GPT-OSS |
| **Gemini Pro** | PR | Gemini 3 Pro (High/Low) |
| **Gemini Flash** | FL | Gemini 3 Flash |

Models within the same group **share quota**.

## Project Structure

```
opencode-antigravity-stats/
├── src/                    # TypeScript source
│   ├── index.ts            # Entry point, event hooks, title formatting
│   ├── collector.ts        # Core logic: tracking, quota fetch, accumulation
│   ├── storage.ts          # Disk persistence
│   ├── watcher.ts          # Monitors antigravity-accounts.json changes
│   ├── types.ts            # TypeScript interfaces
│   └── format.ts           # /stats command output formatting
├── dist/                   # Compiled JavaScript
├── scripts/                # Auxiliary Python scripts
│   ├── quota               # Wrapper script
│   ├── get_antigravity_quota.py  # Main quota fetcher
│   └── setup_tunnel.ps1    # Windows tunnel setup helper
├── package.json
└── README.md
```

## Usage

The plugin works automatically. After sending a message, the session title updates with quota stats.

### Manual Commands

- **/stats** - Show detailed usage statistics

### Quota Script

```bash
# Fetch quota (requires tunnel or local LS)
./scripts/quota

# JSON output
./scripts/quota --json

# Use cached data only
./scripts/quota --cached
```

## Behavior

| Scenario | Title |
|----------|-------|
| Tunnel active | Shows real-time quota stats |
| Tunnel inactive | Title unchanged (no errors) |
| Model "other" | Title unchanged |

## Changelog

See [CHANGELOG.md](CHANGELOG.md) for version history.

## License

MIT
